@inherits Shared.Manager.CreateForm<User>
@using MudBlazor
@using System.Text.Json
@using System.IO
@using Microsoft.Extensions.Configuration;
@inject IHttpClientFactory ClientFactory

<MudForm @ref="_form">
    <MudCard>
        <MudCardContent>
            <MudTextField Required="@true" FullWidth="true" @bind-Value="_precreateItem.firstName"
                Label="First name" />
            <MudTextField Required="@true" FullWidth="true" @bind-Value="_precreateItem.lastName"
                Label="Last name" />
            <MudTextField Required="@true" FullWidth="true" @bind-Value="_precreateItem.phoneNumber"
                Label="Phone number" />
            <MudTextField Required="@true" FullWidth="true" @bind-Value="_precreateItem.email"
                Label="Email address" />
            <MudSelect Required="@true" T="int?" @bind-Value="_precreateItem.role"
                Placeholder="Select user role">
                <MudSelectItem Value="@((int?)1)">Normal user</MudSelectItem>
                <MudSelectItem Value="@((int?)2)">Institution admin</MudSelectItem>
                <MudSelectItem Value="@((int?)3)">System admin</MudSelectItem>
            </MudSelect>
            <MudSelect Required="@true" T="int?" @bind-Value="_precreateItem.institution.id"
                Placeholder="Select what institution the user belongs to">
                @foreach (Institution institution in _institutionList)
                {
                    <MudSelectItem Value="@(institution.id)">@institution.name</MudSelectItem>
                }
            </MudSelect>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="OnAddItem"
                    FullWidth="true">Add user</MudButton>
            </MudCardActions>
            <MudCardActions>
                <MudButton FullWidth="true" @onclick="OnCancel" Variant="Variant.Filled"
                    Color="Color.Warning">Cancel</MudButton>
            </MudCardActions>
        </MudCardContent>
    </MudCard>
</MudForm>

@code
{
    List<Institution> _institutionList = new List<Institution>();

    protected override async Task OnInitializedAsync()
    {
        HttpRequestMessage request = new HttpRequestMessage(HttpMethod.Get,
        Configuration.GetValue<string>("ApiBaseAddress") + "/institutions");

        HttpClient client = ClientFactory.CreateClient();

        HttpResponseMessage response = await client.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            using Stream responseStream = await response.Content.ReadAsStreamAsync();
            _institutionList = await JsonSerializer.DeserializeAsync<List<Institution>>(responseStream);
        }
    }
}